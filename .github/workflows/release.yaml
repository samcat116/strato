name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_HYPERVISOR: ${{ github.repository }}-hypervisor
  IMAGE_NAME_APP: ${{ github.repository }}-app

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # Generate changelog between tags
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)")
          fi
          
          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt
          
          # Create release notes
          cat > release_notes.md << EOF
          ## Changes
          
          $CHANGELOG
          
          ## Docker Images
          
          - \`ghcr.io/${{ github.repository }}-hypervisor:${GITHUB_REF#refs/tags/}\`
          - \`ghcr.io/${{ github.repository }}-app:${GITHUB_REF#refs/tags/}\`
          
          ## Installation
          
          ### Using Docker Compose
          
          \`\`\`bash
          # Update your docker-compose.yml to use the new version
          docker compose pull
          docker compose up -d
          \`\`\`
          
          ### Manual Installation
          
          \`\`\`bash
          # Pull the images
          docker pull ghcr.io/${{ github.repository }}-hypervisor:${GITHUB_REF#refs/tags/}
          docker pull ghcr.io/${{ github.repository }}-app:${GITHUB_REF#refs/tags/}
          \`\`\`
          EOF

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

  build-and-push-images:
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for hypervisor image
        id: meta-hypervisor
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_HYPERVISOR }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Extract metadata for app image
        id: meta-app
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_APP }}
          tags: |
            type=ref,event=tag  
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push hypervisor image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta-hypervisor.outputs.tags }}
          labels: ${{ steps.meta-hypervisor.outputs.labels }}
          cache-from: type=gha,key=hypervisor-${{ matrix.platform }}
          cache-to: type=gha,mode=max,key=hypervisor-${{ matrix.platform }}

      - name: Build and push app image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile-app
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta-app.outputs.tags }}
          labels: ${{ steps.meta-app.outputs.labels }}
          cache-from: type=gha,key=app-${{ matrix.platform }}
          cache-to: type=gha,mode=max,key=app-${{ matrix.platform }}

  build-swift-binaries:
    runs-on: ${{ matrix.os }}
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            asset_name: strato-linux-x86_64
          - os: macos-latest
            asset_name: strato-macos-x86_64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Swift (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: '6.0'

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev zlib1g-dev

      - name: Build Swift binary
        run: |
          swift build -c release

      - name: Package binary
        run: |
          mkdir -p release
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            cp .build/release/App release/strato
            tar czf ${{ matrix.asset_name }}.tar.gz -C release strato
          else
            cp .build/release/App release/strato
            tar czf ${{ matrix.asset_name }}.tar.gz -C release strato
          fi

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./${{ matrix.asset_name }}.tar.gz
          asset_name: ${{ matrix.asset_name }}.tar.gz
          asset_content_type: application/gzip

  upload-source-assets:
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create source archive
        run: |
          git archive --format=tar.gz --prefix=strato-${GITHUB_REF#refs/tags/v}/ HEAD > strato-${GITHUB_REF#refs/tags/v}-source.tar.gz
          git archive --format=zip --prefix=strato-${GITHUB_REF#refs/tags/v}/ HEAD > strato-${GITHUB_REF#refs/tags/v}-source.zip

      - name: Upload source tar.gz
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./strato-${{ github.ref_name }}-source.tar.gz
          asset_name: strato-${{ github.ref_name }}-source.tar.gz
          asset_content_type: application/gzip

      - name: Upload source zip
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./strato-${{ github.ref_name }}-source.zip
          asset_name: strato-${{ github.ref_name }}-source.zip
          asset_content_type: application/zip

      - name: Create docker-compose release file
        run: |
          cat > docker-compose.release.yml << 'EOF'
          version: '3.8'
          
          services:
            db:
              image: postgres:15
              environment:
                POSTGRES_DB: strato
                POSTGRES_USER: strato
                POSTGRES_PASSWORD: strato_password
              volumes:
                - postgres_data:/var/lib/postgresql/data
              ports:
                - "5432:5432"
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U strato"]
                interval: 10s
                timeout: 5s
                retries: 5
          
            permify:
              image: ghcr.io/permify/permify:latest
              command: serve --config=/config/config.yaml
              volumes:
                - ./permify:/config
              ports:
                - "3476:3476"
                - "3478:3478"
              depends_on:
                db:
                  condition: service_healthy
          
            app:
              image: ghcr.io/${{ github.repository }}-app:${{ github.ref_name }}
              environment:
                DATABASE_URL: postgres://strato:strato_password@db:5432/strato
                PERMIFY_ENDPOINT: http://permify:3476
                WEBAUTHN_RELYING_PARTY_ID: localhost
                WEBAUTHN_RELYING_PARTY_NAME: Strato
                WEBAUTHN_RELYING_PARTY_ORIGIN: http://localhost:8080
              ports:
                - "8080:8080"
              depends_on:
                - db
                - permify
          
            migrate:
              image: ghcr.io/${{ github.repository }}-app:${{ github.ref_name }}
              command: migrate
              environment:
                DATABASE_URL: postgres://strato:strato_password@db:5432/strato
              depends_on:
                db:
                  condition: service_healthy
          
          volumes:
            postgres_data:
          EOF

      - name: Upload docker-compose release file
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./docker-compose.release.yml
          asset_name: docker-compose.release.yml
          asset_content_type: text/yaml