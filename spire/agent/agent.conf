# SPIRE Agent Configuration for Strato Hypervisor Nodes
# See https://spiffe.io/docs/latest/deploying/spire_agent/

agent {
    data_dir = "/var/lib/spire/agent"
    log_level = "INFO"
    log_format = "json"

    # SPIRE Server connection
    server_address = "${SPIRE_SERVER_ADDRESS}"
    server_port = "${SPIRE_SERVER_PORT:-8085}"
    trust_domain = "strato.local"

    # Workload API socket - Strato Agent connects here to get SVIDs
    socket_path = "/var/run/spire/sockets/workload.sock"

    # Join token for initial attestation (passed via environment or file)
    join_token = "${SPIRE_JOIN_TOKEN}"

    # For development: allow bootstrap without pre-existing trust bundle
    # Set SPIRE_INSECURE_BOOTSTRAP=true in environment to enable
    insecure_bootstrap = ${SPIRE_INSECURE_BOOTSTRAP:-false}

    # Authorized delegates - agents that can request SVIDs on behalf of workloads
    # Used for VM identity delegation in future phases
    # authorized_delegates = ["spiffe://strato.local/agent/strato-agent"]
}

plugins {
    # NodeAttestor - proves this node's identity to SPIRE Server
    # join_token works on all platforms (Linux, macOS, cloud VMs)
    NodeAttestor "join_token" {
        plugin_data {}
    }

    # Alternative attestors for specific environments:
    #
    # AWS EC2 Instance Identity Document:
    # NodeAttestor "aws_iid" {
    #     plugin_data {
    #         identity_document_url = "http://169.254.169.254/latest/dynamic/instance-identity/document"
    #         identity_signature_url = "http://169.254.169.254/latest/dynamic/instance-identity/signature"
    #     }
    # }
    #
    # GCP Instance Identity Token:
    # NodeAttestor "gcp_iit" {
    #     plugin_data {
    #         service_account = "strato-agent@project.iam.gserviceaccount.com"
    #     }
    # }
    #
    # Azure Managed Identity:
    # NodeAttestor "azure_msi" {
    #     plugin_data {
    #         resource_id = "/subscriptions/.../resourceGroups/.../providers/Microsoft.Compute/virtualMachines/..."
    #     }
    # }

    # KeyManager - stores agent's SVID private key
    KeyManager "disk" {
        plugin_data {
            directory = "/var/lib/spire/agent"
        }
    }

    # WorkloadAttestor - identifies workloads requesting SVIDs
    # unix: Uses Unix process attributes (UID, GID, path)
    WorkloadAttestor "unix" {
        plugin_data {
            discover_workload_path = true
        }
    }

    # Alternative for containerized Strato Agent:
    # WorkloadAttestor "docker" {
    #     plugin_data {
    #         docker_socket_path = "/var/run/docker.sock"
    #     }
    # }
}

# Health check endpoint
health_checks {
    listener_enabled = true
    bind_address = "127.0.0.1"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
