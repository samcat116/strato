# SPIRE Server Configuration for Strato
# See https://spiffe.io/docs/latest/deploying/spire_server/

server {
    bind_address = "0.0.0.0"
    bind_port = "8081"
    trust_domain = "strato.local"
    data_dir = "/var/lib/spire/server"
    log_level = "INFO"
    log_format = "json"

    # CA certificate TTL (root CA)
    ca_ttl = "168h"  # 7 days

    # Default SVID TTLs
    default_x509_svid_ttl = "1h"
    default_jwt_svid_ttl = "5m"

    # Federation settings (for future multi-cluster support)
    federation {
        bundle_endpoint {
            address = "0.0.0.0"
            port = 8443
        }
    }
}

plugins {
    # DataStore plugin - stores registration entries, node info, etc.
    # Use PostgreSQL for production (shares database with control plane)
    DataStore "sql" {
        plugin_data {
            database_type = "postgres"
            connection_string = "host=${SPIRE_DB_HOST} port=${SPIRE_DB_PORT} dbname=${SPIRE_DB_NAME} user=${SPIRE_DB_USER} password=${SPIRE_DB_PASSWORD} sslmode=disable"
        }
    }

    # NodeAttestor plugins - verify node identity
    # join_token: Simple token-based attestation (works everywhere)
    NodeAttestor "join_token" {
        plugin_data {}
    }

    # KeyManager plugin - manages server's signing key
    KeyManager "disk" {
        plugin_data {
            keys_path = "/var/lib/spire/server/keys"
        }
    }

    # Notifier plugin - notify on bundle updates (optional)
    # Notifier "k8sbundle" {
    #     plugin_data {
    #         namespace = "spire"
    #         config_map = "spire-bundle"
    #     }
    # }
}

# Health check endpoint
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
