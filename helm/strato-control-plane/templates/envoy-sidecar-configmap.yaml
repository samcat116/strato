{{- if and .Values.spire.enabled .Values.spire.envoy.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "strato-control-plane.fullname" . }}-envoy-sidecar
  labels:
    {{- include "strato-control-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: envoy-sidecar
data:
  envoy.yaml: |
    node:
      id: {{ include "strato-control-plane.fullname" . }}
      cluster: strato-control-plane

    static_resources:
      listeners:
        # Agent WebSocket listener with mTLS
        - name: agent_mtls_listener
          address:
            socket_address:
              address: 0.0.0.0
              port_value: {{ .Values.spire.envoy.agentPort }}
          filter_chains:
            - transport_socket:
                name: envoy.transport_sockets.tls
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
                  require_client_certificate: true
                  common_tls_context:
                    # Server certificate from SPIRE via SDS
                    tls_certificate_sds_secret_configs:
                      - name: "spiffe://{{ .Values.spire.trustDomain }}/control-plane"
                        sds_config:
                          resource_api_version: V3
                          api_config_source:
                            api_type: GRPC
                            transport_api_version: V3
                            grpc_services:
                              - envoy_grpc:
                                  cluster_name: spire_agent
                    # Trust bundle for validating client (agent) certificates
                    validation_context_sds_secret_config:
                      name: "spiffe://{{ .Values.spire.trustDomain }}"
                      sds_config:
                        resource_api_version: V3
                        api_config_source:
                          api_type: GRPC
                          transport_api_version: V3
                          grpc_services:
                            - envoy_grpc:
                                cluster_name: spire_agent
              filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: agent_mtls
                    codec_type: AUTO
                    upgrade_configs:
                      - upgrade_type: websocket
                    # Forward client certificate details to upstream
                    forward_client_cert_details: SANITIZE_SET
                    set_current_client_cert_details:
                      uri: true
                      cert: false
                      chain: false
                      dns: false
                      subject: true
                    route_config:
                      name: agent_route
                      virtual_hosts:
                        - name: control_plane
                          domains: ["*"]
                          routes:
                            - match:
                                prefix: "/agent/"
                              route:
                                cluster: control_plane_local
                                timeout: 0s  # Disable timeout for WebSocket
                            - match:
                                prefix: "/"
                              route:
                                cluster: control_plane_local
                    http_filters:
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

        # Health check listener (no TLS)
        - name: health_listener
          address:
            socket_address:
              address: 0.0.0.0
              port_value: {{ .Values.spire.envoy.healthPort }}
          filter_chains:
            - filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: health
                    codec_type: AUTO
                    route_config:
                      name: health_route
                      virtual_hosts:
                        - name: health
                          domains: ["*"]
                          routes:
                            - match:
                                prefix: "/health"
                              route:
                                cluster: control_plane_local
                            - match:
                                prefix: "/ready"
                              direct_response:
                                status: 200
                                body:
                                  inline_string: "OK"
                    http_filters:
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
        # Local control plane (upstream)
        - name: control_plane_local
          connect_timeout: 5s
          type: STATIC
          lb_policy: ROUND_ROBIN
          load_assignment:
            cluster_name: control_plane_local
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: 127.0.0.1
                          port_value: {{ .Values.service.port }}

        # SPIRE Agent for SDS (Secret Discovery Service)
        - name: spire_agent
          connect_timeout: 5s
          type: STATIC
          lb_policy: ROUND_ROBIN
          typed_extension_protocol_options:
            envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
              "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
              explicit_http_config:
                http2_protocol_options: {}
          load_assignment:
            cluster_name: spire_agent
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        pipe:
                          path: {{ .Values.spire.envoy.spireAgentSocketPath }}

    admin:
      address:
        socket_address:
          address: 127.0.0.1
          port_value: {{ .Values.spire.envoy.adminPort }}
{{- end }}
