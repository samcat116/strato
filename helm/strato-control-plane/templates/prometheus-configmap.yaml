{{- if and .Values.opentelemetry.enabled .Values.opentelemetry.prometheus.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "strato-control-plane.fullname" . }}-prometheus
  labels:
    {{- include "strato-control-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: {{ .Release.Namespace }}
        service: {{ .Values.opentelemetry.serviceName }}

    # Scrape configurations
    scrape_configs:
      # Scrape Prometheus itself
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:{{ .Values.opentelemetry.prometheus.service.port }}']

      {{- if .Values.opentelemetry.collector.enabled }}
      # Scrape OTel Collector metrics
      - job_name: 'otel-collector'
        static_configs:
          - targets: ['{{ include "strato-control-plane.fullname" . }}-otel-collector:{{ .Values.opentelemetry.collector.service.metricsPort }}']

      # Scrape metrics from OTel Collector's Prometheus exporter
      - job_name: 'otel-metrics'
        static_configs:
          - targets: ['{{ include "strato-control-plane.fullname" . }}-otel-collector:{{ .Values.opentelemetry.collector.service.prometheusPort }}']
      {{- end }}

      # Scrape control plane metrics (if exposed)
      - job_name: 'strato-control-plane'
        static_configs:
          - targets: ['{{ include "strato-control-plane.fullname" . }}:{{ .Values.service.port }}']
        metrics_path: /metrics
        scheme: http

    # Remote write configuration for long-term storage (if needed)
    # remote_write:
    #   - url: "https://remote-storage/api/v1/write"
    #     basic_auth:
    #       username: <username>
    #       password: <password>
{{- end }}
